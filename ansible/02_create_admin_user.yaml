---
# Ansible playbook to:
#  1. Create a new admin user with sudo privileges
#  2. Set up SSH key-based authentication for that user
#
#  If SSH has not been hardened:
#     ansible-playbook ... --user root --ask-pass -e "admin_username=tbone" -e "admin_ssh_public_key='$(cat ~/.ssh/id_ed25519.pub)'"
#
#  If SSH has been hardened:
#     ansible-playbook ... --user <existing_admin_user> --ask-become-pass -e "admin_username=<new_admin_user>" -e "admin_ssh_public_key='<new_admin_user_ssh_public_key>'"

- name: Create an admin user with sudo privileges and SSH key authentication
  hosts: proxmox
  vars:
    admin_username: "{{ admin_username }}"
    admin_ssh_public_key: "{{ admin_ssh_public_key }}"
  vars_prompt:
    - name: admin_password
      prompt: "Enter password for new admin user"
      private: yes
  become: true

  tasks:
    - name: Install sudo
      ansible.builtin.apt:
        name: sudo
        state: present

    - name: Create new user account with sudo privileges
      ansible.builtin.user:
        name: "{{ admin_username }}"
        password: "{{ admin_password | password_hash('sha512') }}"
        shell: /bin/bash
        groups: sudo

    - name: Set up authorized keys for new user
      ansible.posix.authorized_key:
        user: "{{ admin_username }}"
        key: "{{ admin_ssh_public_key }}"
        exclusive: no

    # Verification tasks
    - name: Verify user exists
      ansible.builtin.command: "id {{ admin_username }}"
      register: user_check
      changed_when: false
      tags: verify

    - name: Display user information
      ansible.builtin.debug:
        msg: "User info: {{ user_check.stdout }}"
      tags: verify

    - name: Verify user is in sudo group
      ansible.builtin.command: "groups {{ admin_username }}"
      register: groups_check
      changed_when: false
      failed_when: "'sudo' not in groups_check.stdout"
      tags: verify

    - name: Display user groups
      ansible.builtin.debug:
        msg: "User groups: {{ groups_check.stdout }}"
      tags: verify

    - name: Verify SSH authorized_keys file exists and has correct permissions
      ansible.builtin.stat:
        path: "/home/{{ admin_username }}/.ssh/authorized_keys"
      register: auth_keys_stat
      tags: verify

    - name: Display authorized_keys file status
      ansible.builtin.debug:
        msg:
          - "Authorized keys exists: {{ auth_keys_stat.stat.exists }}"
          - "File permissions: {{ auth_keys_stat.stat.mode | default('N/A') }}"
          - "Owner: {{ auth_keys_stat.stat.pw_name | default('N/A') }}"
      tags: verify

    - name: Verify SSH key is present in authorized_keys
      ansible.builtin.shell: |
        grep -F "{{ admin_ssh_public_key }}" /home/{{ admin_username }}/.ssh/authorized_keys
      register: key_present
      changed_when: false
      failed_when: key_present.rc != 0
      tags: verify

    - name: Display SSH key presence test
      ansible.builtin.debug:
        msg: "SSH public key is present in authorized_keys"
      tags: verify
